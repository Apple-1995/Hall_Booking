<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CON Hall Booking System</title>
    <link rel="icon" href="https://concihsr.in/wp-content/uploads/2024/10/CON-logo-small.png" />
    <style>
        :root {
            --primary: #003366;
            --accent: #0055aa;
            --card: #ffffff;
            --muted: #777;
            --bg: #f4f6f8;
            --success: #28a745;
            --error: #dc3545;
        }
        body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color: #222; }
        header { background: var(--primary); color: white; padding: 18px 10px; display: flex; justify-content: center; align-items: center; }
        header h1 { margin: 0; font-size: 22px; text-align: center; }
        .container { max-width: 1100px; margin: 20px auto; padding: 10px; }
        .nav-links { text-align: center; margin-bottom: 16px; }
        .nav-links a { color: var(--primary); margin: 0 8px; text-decoration: none; padding: 8px 12px; background: #fff; border-radius: 6px; transition: all 0.3s ease; }
        .nav-links a:hover, .nav-links a.active { background: var(--primary); color: white; }
        .content { display: none; background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .content.active { display: block; }
        .form-container { max-width: 900px; margin: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; transition: background 0.3s ease; }
        button:hover { background: var(--accent); }
        button.secondary { background: #666; }
        button.success { background: var(--success); }
        button.error { background: var(--error); }
        .rooms-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        .room-card { background: #fff; border: 1px solid #e6e6e6; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); transition: all 0.2s ease; }
        .room-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .room-card input { width: 18px; height: 18px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal .modal-content { background: #fff; padding: 24px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .admin-login { max-width: 420px; margin: auto; }
        .logo { background: #fff; display: flex; justify-content: center; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: var(--primary); color: white; }
        .stats { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .stat-card { background: #fff; padding: 12px 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex: 1; min-width: 120px; text-align: center; }
        .stat-card h3 { margin: 0; font-size: 24px; color: var(--primary); }
        .stat-card p { margin: 4px 0 0; color: var(--muted); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { color: var(--error); font-size: 14px; margin-top: 4px; display: none; }
        .success-message { color: var(--success); font-size: 14px; margin-top: 4px; display: none; }
        .filter-controls { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-controls select, .filter-controls input { flex: 1; min-width: 150px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<header><h1>CON Hall Booking</h1></header>
<div class="container">
    <div class="nav-links">
        <a href="#" class="nav-link active" data-target="booking">Book Room</a>
        <a href="#" class="nav-link" data-target="events">View Events</a>
        <a href="#" class="nav-link" data-target="admin-login">Admin</a>
        <a href="#" class="nav-link" data-target="admin" id="admin-nav" style="display:none;">Dashboard</a>
        <a href="#" class="nav-link" id="logout-btn" style="display:none; background:var(--error); color:white;">Logout</a>
    </div>
    <!-- Booking Section -->
    <div class="content active" id="booking">
        <h2>Book Conference Rooms</h2>
        <div class="form-container">
            <div class="form-group">
                <label>Rooms <span class="error-message" id="roomsError">Select at least one room</span></label>
                <div id="roomsContainer" class="rooms-grid"></div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Event Name <span class="error-message" id="eventNameError">Event name is required</span></label>
                    <input type="text" id="eventName">
                </div>
                <div class="form-group">
                    <label>Department <span class="error-message" id="departmentError">Department is required</span></label>
                    <input type="text" id="department">
                </div>
                <div class="form-group">
                    <label>Start Date <span class="error-message" id="startDateError">Valid start date is required</span></label>
                    <input type="date" id="startDate" min="">
                </div>
                <div class="form-group">
                    <label>End Date <span class="error-message" id="endDateError">Valid end date is required</span></label>
                    <input type="date" id="endDate" min="">
                </div>
                <div class="form-group">
                    <label>Start Time <span class="error-message" id="startTimeError">Start time is required</span></label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label>End Time <span class="error-message" id="endTimeError">Valid end time is required</span></label>
                    <input type="time" id="endTime">
                </div>
                <div class="form-group">
                    <label>Participants <span class="error-message" id="participantsError">Must have at least 1 participant</span></label>
                    <input type="number" id="participants" value="1" min="1">
                </div>
                <div class="form-group"><label>Notes</label><textarea id="notes"></textarea></div>
            </div>
            <div style="margin-top:12px;">
                <button id="bookingButton">Submit Booking</button>
                <button id="resetButton" class="secondary">Reset Form</button>
                <span class="success-message" id="bookingSuccess">Booking submitted successfully!</span>
            </div>
        </div>
    </div>
    <!-- Events Section -->
    <div class="content" id="events">
        <h2>Scheduled Events</h2>
        <div class="filter-controls">
            <select id="roomFilter"><option value="">All Rooms</option></select>
            <input type="date" id="dateFilter">
            <button id="clearFilters">Clear Filters</button>
        </div>
        <div id="eventsList"></div>
    </div>
    <!-- Admin Login Section -->
    <div class="content" id="admin-login">
        <div class="admin-login">
            <div class="logo"><img src="https://concihsr.in/wp-content/uploads/2024/10/CON-logo-small.png" alt="logo" style="height:48px;"></div>
            <h3 style="text-align:center;margin-top:0;">Admin Login</h3>
            <div class="form-container">
                <div class="form-group"><label>Username</label><input type="text" id="adminUsername"></div>
                <div class="form-group"><label>Password</label><input type="password" id="adminPassword"></div>
                <div style="text-align:center;margin-top:8px;">
                    <button id="adminLoginButton">Login</button>
                    <div class="loading" id="loginLoading" style="display:none;"></div>
                </div>
                <div id="adminLoginError" class="error-message">Invalid login credentials</div>
            </div>
        </div>
    </div>
    <!-- Admin Dashboard Section -->
    <div class="content" id="admin">
        <h2>Admin Dashboard</h2>
        <div class="stats">
            <div class="stat-card"><h3 id="pendingCount">0</h3><p>Pending Requests</p></div>
            <div class="stat-card"><h3 id="approvedCount">0</h3><p>Approved Bookings</p></div>
            <div class="stat-card"><h3 id="totalRooms">0</h3><p>Available Rooms</p></div>
        </div>
        <h3>Add New Room</h3>
        <div class="form-container">
            <div class="form-group">
                <input type="text" id="newRoomName" placeholder="Room name">
                <span class="error-message" id="roomNameError">Room name is required</span>
            </div>
            <div>
                <button id="addRoomButton">Add Room</button>
                <span class="success-message" id="roomSuccess">Room added successfully!</span>
            </div>
        </div>
        <h3>Pending Approval</h3>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Event</th><th>Rooms</th><th>Dates</th><th>Time</th><th>Participants</th><th>Dept</th><th>Actions</th></tr></thead>
                <tbody id="pendingRequests"></tbody>
            </table>
        </div>
        <h3>Approved Bookings</h3>
        <div class="filter-controls">
            <input type="date" id="approvedDateFilter">
            <button id="clearApprovedFilter">Clear Filter</button>
        </div>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Event</th><th>Rooms</th><th>Dates</th><th>Time</th><th>Participants</th><th>Dept</th><th>Actions</th></tr></thead>
                <tbody id="approvedBookings"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="messageModal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <div id="modalContent"></div>
    <div style="text-align:right;margin-top:16px;"><button id="modalOkButton">OK</button></div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// Utility
const $ = (id) => document.getElementById(id);
const show = (el, on=true) => el.style.display = on ? '' : 'none';
const formatDateRange = (s,e) => `${s} – ${e}`;
const formatTimeRange = (s,e) => `${s} – ${e}`;
const todayISO = () => new Date().toISOString().slice(0,10);

// Tabs
document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
    link.classList.add('active');
    const target = link.dataset.target;
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    if (target) $(target).classList.add('active');
  });
});

// Modal
function modal(title, content) {
  $('modalTitle').innerText = title;
  $('modalContent').innerHTML = content;
  const m = $('messageModal');
  m.style.display = 'flex';
  $('modalOkButton').onclick = ()=> m.style.display='none';
}

// Dates min
$('startDate').min = todayISO();
$('endDate').min = todayISO();

// Load rooms
async function loadRooms() {
  const params = new URLSearchParams();
  const sD = $('startDate').value, eD = $('endDate').value, sT = $('startTime').value, eT = $('endTime').value;
  if (sD && eD && sT && eT) {
    params.set('startDate', sD); params.set('endDate', eD);
    params.set('startTime', sT); params.set('endTime', eT);
  }
  const res = await fetch('/rooms?' + params.toString());
  const rooms = await res.json();
  const container = $('roomsContainer');
  container.innerHTML = '';
  rooms.forEach(r => {
    const div = document.createElement('label');
    div.className = 'room-card';
    div.innerHTML = `<input type="checkbox" value="${r.name}" ${r.available ? '' : 'disabled'}>
                     <span>${r.name}</span> ${r.available ? '' : '<small>(Unavailable)</small>'}`;
    container.appendChild(div);
  });
  // fill filter
  const rf = $('roomFilter');
  rf.innerHTML = '<option value="">All Rooms</option>' + rooms.map(r=>`<option>${r.name}</option>`).join('');
}
['startDate','endDate','startTime','endTime'].forEach(id=>$(id).addEventListener('change', loadRooms));

// Submit booking
$('bookingButton').addEventListener('click', async () => {
  // validations
  const selectedRooms = Array.from(document.querySelectorAll('#roomsContainer input:checked')).map(i=>i.value);
  const data = {
    eventName: $('eventName').value.trim(),
    department: $('department').value.trim(),
    startDate: $('startDate').value,
    endDate: $('endDate').value,
    startTime: $('startTime').value,
    endTime: $('endTime').value,
    participants: $('participants').value,
    notes: $('notes').value,
    rooms: selectedRooms
  };

  // show inline errors
  const errs = {
    roomsError: selectedRooms.length === 0,
    eventNameError: !data.eventName,
    departmentError: !data.department,
    startDateError: !data.startDate,
    endDateError: !data.endDate || (data.endDate < data.startDate),
    startTimeError: !data.startTime,
    endTimeError: !data.endTime || (data.endTime <= data.startTime),
    participantsError: !(parseInt(data.participants) >= 1)
  };
  Object.entries(errs).forEach(([id, bad]) => show($(id), bad));
  if (Object.values(errs).some(Boolean)) return;

  const btn = $('bookingButton');
  const orig = btn.innerText;
  btn.disabled = true; btn.innerHTML = 'Submitting…';

  try {
    const res = await fetch('/book', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const out = await res.json();
    if (!res.ok || !out.success) throw new Error(out.error || 'Failed to submit');
    show($('bookingSuccess'), true);
    modal('Booking Submitted', 'Your booking is pending admin approval.');
    loadRooms(); // refresh availability
    loadEvents(); // refresh events
  } catch (e) {
    modal('Error', e.message);
  } finally {
    btn.disabled = false; btn.innerHTML = orig;
  }
});

$('resetButton').addEventListener('click', () => {
  document.querySelectorAll('input, textarea').forEach(el => { if (el.type !== 'date' && el.type !== 'time') el.value = ''; });
  document.querySelectorAll('#roomsContainer input:checked').forEach(i=> i.checked = false);
  show($('bookingSuccess'), false);
});

// Events list (approved only)
async function loadEvents() {
  const params = new URLSearchParams();
  params.set('status','approved');
  const room = $('roomFilter').value;
  const date = $('dateFilter').value;
  if (room) params.set('room', room);
  if (date) params.set('date', date);
  const res = await fetch('/bookings?' + params.toString());
  const events = await res.json();
  const wrap = $('eventsList');
  if (events.length === 0) { wrap.innerHTML = '<p>No events found.</p>'; return; }
  wrap.innerHTML = `<table>
    <thead><tr><th>Event</th><th>Rooms</th><th>Dates</th><th>Time</th><th>Participants</th><th>Dept</th></tr></thead>
    <tbody>
      ${events.map(e => `<tr>
        <td>${e.eventName}</td>
        <td>${(e.rooms||[]).join(', ')}</td>
        <td>${formatDateRange(e.startDate, e.endDate)}</td>
        <td>${formatTimeRange(e.startTime, e.endTime)}</td>
        <td>${e.participants||1}</td>
        <td>${e.department||''}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}
$('roomFilter').addEventListener('change', loadEvents);
$('dateFilter').addEventListener('change', loadEvents);
$('clearFilters').addEventListener('click', () => { $('roomFilter').value=''; $('dateFilter').value=''; loadEvents(); });

// Admin login
let isAdmin = false;
$('adminLoginButton').addEventListener('click', async () => {
  show($('loginLoading'), true);
  $('adminLoginError').style.display = 'none';
  try {
    const res = await fetch('/admin/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username: $('adminUsername').value, password: $('adminPassword').value })
    });
    const out = await res.json();
    if (!out.success) throw new Error('Invalid login');
    isAdmin = true;
    document.querySelector('[data-target="admin"]').style.display = '';
    $('admin-nav').style.display = '';
    $('logout-btn').style.display = '';
    // switch to admin tab
    document.querySelector('[data-target="admin"]').click();
    refreshAdmin();
  } catch (e) {
    $('adminLoginError').style.display = '';
  } finally {
    show($('loginLoading'), false);
  }
});

$('logout-btn').addEventListener('click', () => {
  isAdmin = false;
  $('admin-nav').style.display = 'none';
  $('logout-btn').style.display = 'none';
  // go back to booking
  document.querySelector('[data-target="booking"]').click();
});

// Admin: fetch stats & lists
async function refreshAdmin() {
  const s = await (await fetch('/stats')).json();
  $('pendingCount').innerText = s.pending;
  $('approvedCount').innerText = s.approved;
  $('totalRooms').innerText = s.total_rooms;

  const pending = await (await fetch('/bookings?status=pending')).json();
  const approved = await (await fetch('/bookings?status=approved' + ( $('approvedDateFilter').value ? '&date=' + $('approvedDateFilter').value : '' ))).json();
  renderBookingRows('pendingRequests', pending, true);
  renderBookingRows('approvedBookings', approved, false);
}

$('approvedDateFilter').addEventListener('change', refreshAdmin);
$('clearApprovedFilter').addEventListener('click', () => { $('approvedDateFilter').value=''; refreshAdmin(); });

function renderBookingRows(containerId, list, showApproveReject) {
  const tbody = $(containerId);
  tbody.innerHTML = list.map(b => `<tr>
      <td>${b.eventName}</td>
      <td>${(b.rooms||[]).join(', ')}</td>
      <td>${formatDateRange(b.startDate, b.endDate)}</td>
      <td>${formatTimeRange(b.startTime, b.endTime)}</td>
      <td>${b.participants||1}</td>
      <td>${b.department||''}</td>
      <td>
        ${showApproveReject ? `
          <button data-act="approve" data-id="${b.id}" class="success">Approve</button>
          <button data-act="reject" data-id="${b.id}" class="error">Reject</button>
        ` : ''}
        <button data-act="delete" data-id="${b.id}" class="secondary">Delete</button>
      </td>
    </tr>`).join('');
  tbody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id, act = btn.dataset.act;
      try {
        const res = await fetch(`/admin/${act}/${id}`, { method: 'POST' });
        const out = await res.json();
        if (!out.success) throw new Error(out.error || 'Action failed');
        modal('Success', 'Action completed.');
        refreshAdmin();
        loadEvents();
      } catch (e) {
        modal('Error', e.message);
      }
    });
  });
}

// Admin add room
$('addRoomButton').addEventListener('click', async () => {
  const name = $('newRoomName').value.trim();
  if (!name) { $('roomNameError').style.display=''; return; }
  $('roomNameError').style.display='none';
  try {
    const res = await fetch('/admin/add-room', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name})
    });
    const out = await res.json();
    if (!out.success) throw new Error(out.error || 'Failed');
    $('roomSuccess').style.display='';
    setTimeout(()=> $('roomSuccess').style.display='none', 2500);
    $('newRoomName').value='';
    loadRooms(); refreshAdmin();
  } catch (e) {
    modal('Error', e.message);
  }
});

// Initial loads
loadRooms();
loadEvents();

// Socket updates
const socket = io();
socket.on('update_events', () => {
  loadEvents();
  refreshAdmin();
});
</script>
</body>
</html>